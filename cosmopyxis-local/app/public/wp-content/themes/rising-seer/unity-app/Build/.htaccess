# Unity WebGL Safari Fix - Multi-layered approach for maximum compatibility
# Works with Apache, LiteSpeed, and nginx (via Apache proxy)

# Layer 1: Remove default .gz MIME type association
<IfModule mod_mime.c>
    RemoveType .gz
    RemoveEncoding .gz
</IfModule>

# Layer 2: Force correct MIME types using multiple methods
<FilesMatch "\.wasm\.gz$">
    ForceType application/wasm
    <IfModule mod_headers.c>
        Header set Content-Encoding gzip
        Header set Content-Type application/wasm
    </IfModule>
</FilesMatch>

<FilesMatch "\.data\.gz$">
    ForceType application/octet-stream
    <IfModule mod_headers.c>
        Header set Content-Encoding gzip
        Header set Content-Type application/octet-stream
    </IfModule>
</FilesMatch>

<FilesMatch "\.js\.gz$">
    ForceType application/javascript
    <IfModule mod_headers.c>
        Header set Content-Encoding gzip
        Header set Content-Type application/javascript
    </IfModule>
</FilesMatch>

# Layer 3: Rewrite approach (most compatible with LiteSpeed)
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Set environment variables for .gz files
    RewriteRule \.wasm\.gz$ - [E=FORCE_TYPE:application/wasm,E=ADD_ENCODING:gzip]
    RewriteRule \.data\.gz$ - [E=FORCE_TYPE:application/octet-stream,E=ADD_ENCODING:gzip]
    RewriteRule \.js\.gz$ - [E=FORCE_TYPE:application/javascript,E=ADD_ENCODING:gzip]
    
    # Apply headers based on environment variables
    <IfModule mod_headers.c>
        Header set Content-Type "%{FORCE_TYPE}e" env=FORCE_TYPE
        Header set Content-Encoding "%{ADD_ENCODING}e" env=ADD_ENCODING
    </IfModule>
</IfModule>

# Layer 4: LiteSpeed-specific directives
<IfModule LiteSpeed>
    ForceType application/wasm
    <FilesMatch "\.gz$">
        Header set Content-Encoding gzip
    </FilesMatch>
</IfModule>

# Layer 5: PHP fallback for local development only
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Only use PHP proxy for specific local domains
    RewriteCond %{HTTP_HOST} ^cosmopyxis\.local$ [OR]
    RewriteCond %{HTTP_HOST} ^localhost$
    RewriteRule ^(unity-app\.(wasm|data|framework\.js|loader\.js)\.gz)$ serve-gz.php?file=$1 [L,QSA]
</IfModule>

# Prevent double compression
<IfModule mod_deflate.c>
    SetEnvIfNoCase Request_URI \.gz$ no-gzip dont-vary
</IfModule>
